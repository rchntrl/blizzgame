<?php/** * Class GalleryImage * * @property string Title Title of the Gallery Image * @property string Size * @property Integer maxSize * @property string LastLinkSegment * @method PeopleFace Author() * @method Image Image() */class GalleryImage extends DataObject {    public static $db = array(        'Title' => 'Varchar(280)',        'Size' => 'Varchar(20)',        'MaxSize' => "Int",        'LastLinkSegment' => 'Varchar(255)'    );    private static $indexes = array(        'UniqueLastLinkSegment' => 'unique("LastLinkSegment")'    );    // One-to-one relationship with gallery page    public static $has_one = array(        'Author' =>	'PeopleFace',        'Image' => 'Image',        'GalleryPage' => 'GalleryPage',    );    static $many_many = array(        'Tags' => 'ElementLink',    );    public static $summary_fields = array(        'Title',        'Author.TitleEN',        'Thumbnail',    );    public static $field_labels = array(        'Author.TitleEN' => 'Artist',    );    public function fieldLabels() {        return array_merge(self::$field_labels,            array(                'Author.TitleEN' => _t('Gallery.Author', 'Artist'),            )        );    }    //Permissions    function canEdit($Member = null){        return (permission::check('EDIT_GALLERY')) ? true : false;    }    function canCreate($Member = null){        return (permission::check('EDIT_GALLERY')) ? true : false;    }    function canDelete($Member = null){       return (permission::check('DELETE_GALLERY')) ? true : false;    }    public function getCMSFields() {        $fields = parent::getCMSFields();        $fields->removeFieldFromTab("Root.Main","GalleryPageID");        $fields->removeFieldFromTab("Root.Main","SortOrder");        $fields->replaceField(            'AuthorID',            new DropdownField(                'AuthorID',                'Author',                PeopleFace::getOnly('Artist')->map('ID', 'TitleEN')            )        );        $fields->addFieldToTab(            "Root.Main",            new ListboxField(                'Tags',                'Tags',                DataObject::get('ElementLink', "\"ElementLink\".\"SubsiteID\" =" . Subsite::currentSubsiteID(), 'TitleEn')->map('ID', 'TitleEN'),                '',     // value                8,      // size                true    // multiple            ),            'AuthorID'        );        return $fields;    }    public function onBeforeWrite() {        $image = $this->Image;        if ($image->ID) {            $MaxSize = ($image->GetWidth() > $image->GetHeight()) ? $image->GetWidth() : $image->GetHeight();            switch (true) {                case $this->MaxSize < 700:                    $this->Size = 'small';                    break;                case $MaxSize >= 700 and $MaxSize < 1400:                    $this->Size = 'medium';                    break;                case $MaxSize >= 1400 and $MaxSize < 3000:                    $this->Size = 'large';                    break;                case $MaxSize >= 3000:                    $this->Size = 'extra-large';                    break;            }            $this->maxSize = $MaxSize;            $this->LastLinkSegment = $image->Name;        }        parent::onBeforeWrite();    }    // Add validation    public function validate() {        $result = parent::validate();        $charCount = strlen($this->Title);        $description = 'You should have less than 280 characters in the description. You have';        if($charCount > 280) {            $result->error($description . ' ' . $charCount);        }        return $result;    }    // this function creates the thumbnail for the summary fields to use    public function getThumbnail() {        return $this->Image()->CMSThumbnail();    }}